$ ->
  initializeExtendedFilter = ->
    if $('form#issues-filter').length == 1
      KS.initializeFormActions()

  $(document).on 'turbolinks:load', initializeExtendedFilter

  $(document).on 'change', '#status_note_template', ->
    $('#issue_status_note').val($('#status_note_template')[0]['value'])
    $('#status_note_template').val('')

  $(document).on 'click', '#issue_email_direct', (e) ->
    e.preventDefault()
    $.ajax
      url: $('#issue_email_direct').attr('href')
      type: 'GET'
      success: (data) ->
        location.href = data

  $(document).on 'click', '#issue_export', (e) ->
    reopen = false
    if $('#map').size() == 0
      $('#print-map').attr('id', 'map')
    else
      reopen = true
    $('#map').html('')
    KS.initializeMaps(false)
    e.preventDefault()
    href = $('#issue_export').attr('href')

    window.setTimeout (->
      canvas = document.getElementsByTagName('canvas').item(0)
      img = canvas.toDataURL('image/png')

      req = new XMLHttpRequest
      req.open 'POST', $('#issue_export').attr('href'), true
      req.responseType = 'blob'
      req.setRequestHeader "Content-Type", "application/x-www-form-urlencoded; charset=UTF-8"
      req.send 'map_image=' + btoa(img)

      req.onload = (event) ->
        blob = req.response
        link = document.createElement('a')
        link.href = window.URL.createObjectURL(blob)
        link.download = req.getResponseHeader('X-FileName')
        link.click()

      $('#map').html('')
      KS.initializeMaps(true)
    ), 1000

  $(document).on 'click', '.card .btn-create', (e) ->
    e.preventDefault()
    link = $(e.target).parents('.card').find('.btn-create')
    $.ajax
      url: link.attr('href')
      type: 'POST'
      data: link.parents('.card').find(':input')

  $(document).on 'click', '.card .btn-update', (e) ->
    e.preventDefault()
    link = $(e.target).parents('.card').find('.btn-update')
    $.ajax
      url: link.attr('href')
      type: 'PUT'
      data: link.parents('.card').find(':input')

  $(document).on 'click', '#dms_link', (e) ->
    e.preventDefault()
    open_url = ''
    $.ajax
      url: '<%= Rails.application.routes.url_helpers.dms_index_path %>'
      type: 'GET'
      data: { issue_id: $(e.target).data('id') }
      async: false
      success: (data) ->
        open_url = data
    window.open(open_url, '_blank')

  $(document).on 'click', 'tr:not(.active) img.imagezoom', (e) ->
    e.preventDefault()
    tr = $(e.target).parents('tr')
    $('#' + tr.attr('id').replace('_big', '')).hide()
    $('#' + tr.attr('id') + '_big').show()

  $(document).on 'click', '.image-big img', (e) ->
    e.preventDefault()
    tr = $(e.target).parents('tr')
    $('#' + tr.attr('id').replace('_big', '')).show()
    $('#' + tr.attr('id')).hide()
